name: Build and Push Multi-Platform Nexus Docker Image

on:
    push:
        tags:
            - '[0-9]+.[0-9]+.[0-9]+*'
    workflow_dispatch:
        inputs:
            docker_tag:
                description: 'Docker image tag (e.g. 3.63.0-01)'
                required: true
                default: 'test-latest'
            platforms:
                description: 'Build platforms (comma-separated)'
                required: false
                default: 'linux/amd64,linux/arm64'

env:
    DOCKER_IMAGE: diwuyunhe/nexus3

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up QEMU for multi-arch emulation
                uses: docker/setup-qemu-action@v3

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Log in to Docker Hub
                uses: docker/login-action@v3
                with:
                    username: ${{ secrets.DOCKERHUB_USERNAME }}
                    password: ${{ secrets.DOCKERHUB_TOKEN }}

            -   name: Determine Docker tag
                id: get_tag
                run: |
                    EVENT_NAME="${{ github.event_name }}"
                    REF="${{ github.ref }}"
                    SHA_SHORT="${GITHUB_SHA::8}"
                    
                    if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
                      CUSTOM_TAG="${{ github.event.inputs.docker_tag }}"
                      if [[ -n "$CUSTOM_TAG" ]]; then
                        TAG="$CUSTOM_TAG"
                      else
                        TAG="manual-$SHA_SHORT"
                      fi
                    elif [[ "$REF" == refs/tags/* ]]; then
                      TAG="${REF#refs/tags/}"
                    elif [[ "$REF" == refs/heads/* ]]; then
                      BRANCH="${REF#refs/heads/}"
                      BRANCH_CLEAN="${BRANCH//\//-}"
                      BRANCH_CLEAN="${BRANCH_CLEAN,,}"
                      TAG="${BRANCH_CLEAN}-${SHA_SHORT}"
                    else
                      TAG="unknown-$SHA_SHORT"
                    fi
                    
                    if [[ ! "$TAG" =~ ^[a-zA-Z0-9._-]+$ ]]; then
                      echo "Error: Invalid characters in tag: $TAG"
                      exit 1
                    fi
                    
                    echo "Computed Docker tag: $TAG"
                    echo "TAG=${TAG}" >> $GITHUB_ENV

            -   name: Build and push
                uses: docker/build-push-action@v6
                with:
                    context: .
                    file: ./Dockerfile
                    platforms: linux/amd64,linux/arm64
                    push: true
                    tags: |
                        ${{ env.DOCKER_IMAGE }}:${{ env.TAG }}
                    cache-from: type=gha
                    cache-to: type=gha,mode=max